name: CI/CD Pipeline - DevSecOps

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.6'

jobs:
  # ============================================
  # JOB 1: ANÃLISIS DE SEGURIDAD DEL CÃ“DIGO PYTHON
  # ============================================
  python-security-scan:
    name: ðŸ Python Security & Quality
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6

      - name: ðŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Instalar dependencias Python
        run: |
          python -m pip install --upgrade pip
          pip install pandas
          pip install bandit[toml] black ruff flake8 pylint mypy safety

      - name: ðŸ” Bandit - Security Scanner
        run: |
          echo "ðŸ”’ Analizando vulnerabilidades de seguridad en cÃ³digo Python..."
          python -m bandit -r app/src/main/python/ -f json -o bandit-report.json || true
          python -m bandit -r app/src/main/python/ -f txt
        continue-on-error: true

      - name: ðŸŽ¨ Black - Code Formatter Check
        run: |
          echo "âœ¨ Verificando formato del cÃ³digo Python..."
          python -m black --check --diff app/src/main/python/
        continue-on-error: true

      - name: âš¡ Ruff - Fast Linter
        run: |
          echo "âš¡ Ejecutando Ruff linter..."
          python -m ruff check app/src/main/python/ --output-format=github
        continue-on-error: true

      - name: ðŸ”¬ Flake8 - Style Guide Enforcement
        run: |
          echo "ðŸ“ Verificando estilo con Flake8..."
          python -m flake8 app/src/main/python/ --max-line-length=120 --extend-ignore=E203,W503
        continue-on-error: true

      - name: ðŸ›¡ï¸ Safety - Dependency Vulnerability Scanner
        run: |
          echo "ðŸ” Verificando vulnerabilidades en dependencias Python..."
          pip freeze | python -m safety check --stdin || true
        continue-on-error: true

      - name: ðŸ“Š Upload Bandit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  # ============================================
  # JOB 2: ANÃLISIS DE SEGURIDAD ANDROID/KOTLIN
  # ============================================
  android-security-scan:
    name: ðŸ¤– Android Security & Quality
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6

      - name: â˜• Setup JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ Setup Python (para Chaquopy)
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Instalar pandas (requerido por Chaquopy)
        run: pip install pandas

      - name: ðŸ”§ Make gradlew executable
        run: chmod +x ./gradlew

      - name: ðŸ” Create google-services.json from secret
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: ðŸ§¹ Android Lint
        run: |
          echo "ðŸ” Ejecutando Android Lint..."
          ./gradlew lintDebug
        continue-on-error: true

      - name: ðŸ“Š Upload Lint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-lint-report
          path: app/build/reports/lint-results-debug.html
          if-no-files-found: warn

      - name: ðŸ“Š Upload Build Error Reports
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: android-build-errors
          path: |
            build/reports/
            app/build/reports/
            **/build/reports/problems/
          if-no-files-found: ignore

      - name: ðŸ“¦ Cache NVD Database
        uses: actions/cache@v4
        with:
          path: ~/.gradle/dependency-check-data
          key: nvd-database-${{ runner.os }}-${{ hashFiles('**/build.gradle') }}
          restore-keys: |
            nvd-database-${{ runner.os }}-

      - name: ðŸ” OWASP Dependency Check
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        timeout-minutes: 10
        run: |
          echo "ðŸ›¡ï¸ Verificando vulnerabilidades en dependencias Android..."
          if [ -n "$NVD_API_KEY" ]; then
            echo "ðŸ“Š Usando NVD API Key para anÃ¡lisis rÃ¡pido"
            ./gradlew dependencyCheckAnalyze \
              -PnvdApiKey="$NVD_API_KEY" \
              --no-daemon \
              --max-workers=2 \
              || true
          else
            echo "âš ï¸ NVD API Key no encontrada - anÃ¡lisis serÃ¡ lento"
            ./gradlew dependencyCheckAnalyze \
              --no-daemon \
              --max-workers=2 \
              || true
          fi
        continue-on-error: true

      - name: ðŸ“Š Upload OWASP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: |
            **/build/reports/dependency-check-report.*
            build/reports/*.html
            build/reports/*.json
          if-no-files-found: warn
          retention-days: 30

  # ============================================
  # JOB 3: TESTS UNITARIOS
  # ============================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [python-security-scan, android-security-scan]

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6

      - name: â˜• Setup JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Instalar dependencias Python
        run: |
          pip install pandas
          pip install pytest pytest-cov

      - name: ðŸ”§ Make gradlew executable
        run: chmod +x ./gradlew

      - name: ðŸ” Create google-services.json from secret
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: ðŸ§ª Run Unit Tests
        run: ./gradlew testDebugUnitTest
        continue-on-error: false

      - name: ðŸ“Š Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            app/build/reports/tests/
            app/build/test-results/
          if-no-files-found: warn

      - name: ðŸ“Š Upload Build Reports (on failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-error-reports
          path: |
            build/reports/
            app/build/reports/
            **/build/reports/problems/
          if-no-files-found: ignore

  # ============================================
  # JOB 4: BUILD RELEASE AAB (Solo en Release)
  # ============================================
  build-release:
    name: ðŸ“¦ Build Release AAB
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v6

      - name: â˜• Setup JDK
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Instalar pandas
        run: pip install pandas

      - name: ðŸ”§ Make gradlew executable
        run: chmod +x ./gradlew

      - name: ðŸ” Create google-services.json from secret
        run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: ðŸ”¨ Build Release AAB
        env:
          ADMOB_APP_ID_RELEASE: ${{ secrets.ADMOB_APP_ID_RELEASE }}
          ADMOB_INTERSTITIAL_ID_RELEASE: ${{ secrets.ADMOB_INTERSTITIAL_ID_RELEASE }}
          ADMOB_NATIVE_ADULTOS_ID_RELEASE: ${{ secrets.ADMOB_NATIVE_ADULTOS_ID_RELEASE }}
          ADMOB_NATIVE_MENORES_ID_RELEASE: ${{ secrets.ADMOB_NATIVE_MENORES_ID_RELEASE }}
        run: ./gradlew bundleRelease

      - name: ðŸ”‘ Sign AAB
        uses: r0adkll/sign-android-release@v1
        id: sign_aab
        with:
          releaseDirectory: app/build/outputs/bundle/release
          signingKeyBase64: ${{ secrets.KEYSTORE_FILE }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      - name: ðŸ“¤ Upload Signed AAB
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: ${{ steps.sign_aab.outputs.signedReleaseFile }}

      - name: ðŸ“ Generate Release Notes
        run: |
          echo "# ðŸš€ Release Build" > release-notes.txt
          echo "" >> release-notes.txt
          echo "**Version:** $(grep versionName app/build.gradle | awk '{print $2}' | tr -d '"')" >> release-notes.txt
          echo "**Build Number:** $(grep versionCode app/build.gradle | awk '{print $2}')" >> release-notes.txt
          echo "**Build Date:** $(date +'%Y-%m-%d %H:%M:%S')" >> release-notes.txt
          echo "**Commit:** ${{ github.sha }}" >> release-notes.txt

      - name: ðŸ“„ Upload Release Notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release-notes.txt

  # ============================================
  # JOB 5: DEPLOY A GOOGLE PLAY (MANUAL)
  # ============================================
  deploy-to-play-store:
    name: ðŸš€ Deploy to Play Store
    runs-on: ubuntu-latest
    needs: [build-release]
    if: github.event_name == 'release'
    environment:
      name: production
      url: https://play.google.com/store/apps/details?id=com.allesterdev.imcpractico

    steps:
      - name: ðŸ“¥ Download Signed AAB
        uses: actions/download-artifact@v4
        with:
          name: signed-aab

      - name: ðŸš€ Upload to Play Store (Internal Testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON }}
          packageName: com.allesterdev.imcpractico
          releaseFiles: app-release.aab
          track: internal
          status: completed
          inAppUpdatePriority: 2

  # ============================================
  # JOB 6: NOTIFICACIONES Y RESUMEN
  # ============================================
  notify-results:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [python-security-scan, android-security-scan, unit-tests]
    if: always()

    steps:
      - name: ðŸ“Š Summary Report
        run: |
          echo "## ðŸŽ¯ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Security Scan:** ${{ needs.python-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Android Security Scan:** ${{ needs.android-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests:** ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Pipeline completado exitosamente!" >> $GITHUB_STEP_SUMMARY
